/*
 * Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved.
 */
package com.sap.hybris.sapcustomerb2c.strategy;

import static de.hybris.platform.servicelayer.util.ServicesUtil.validateParameterNotNull;

import de.hybris.platform.commerceservices.customer.CustomerService;
import de.hybris.platform.commerceservices.strategies.UserPropertyMatchingStrategy;
import de.hybris.platform.core.model.user.CustomerModel;
import de.hybris.platform.core.model.user.UserModel;

import java.util.Optional;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * SAP customer ID matching strategy implementation for {@link UserPropertyMatchingStrategy}.
 * The customerId pattern used in OCC should match the customerId pattern generated by the sapCustomerIdGenerator.
 */
public class SapCustomerIdMatchingStrategy implements UserPropertyMatchingStrategy
{
	private static final Pattern SAP_CUSTOMER_ID_PATTERN = Pattern.compile("^\\d{1,10}");
	private final CustomerService customerService;

	public SapCustomerIdMatchingStrategy(final CustomerService customerService)
	{
		this.customerService = customerService;
	}

	@Override
	public <T extends UserModel> Optional<T> getUserByProperty(final String propertyValue, final Class<T> clazz)
	{
		validateParameterNotNull(propertyValue, "The property value used to identify a customer must not be null");
		validateParameterNotNull(clazz, "The class of returned user model must not be null");
		return isSupported(propertyValue, clazz) ?
				Optional.ofNullable((T) getCustomerService().getCustomerByCustomerId(propertyValue)) :
				Optional.empty();
	}

	protected boolean isSupported(final String propertyValue, final Class<?> clazz)
	{
		final Matcher matcher = SAP_CUSTOMER_ID_PATTERN.matcher(propertyValue);
		return matcher.matches() && clazz.isAssignableFrom(CustomerModel.class);
	}

	public CustomerService getCustomerService()
	{
		return customerService;
	}
}
